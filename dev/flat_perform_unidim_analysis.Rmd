---
title: "flat_perform_unidim_analysis.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
library(ggplot2)
library(RColorBrewer)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

# `plot_unidim_analysis()`: Create the plot with the unidimensional analysis

With `plot_unidim_analysis()`, you can create an interactive plot to visualize the intensity of the different sensory attributes in the products. The graph displays the products on the x-axis, and the average intensity on the y-axis (on a 0-10 scale). There are as many graphs as there are sensory attributes. The graph is interactive, so you can decide to display only certain products, for example. 

```{r function-perform_unidim_analysis}
#' Create the plot with the unidimensional analysis
#' 
#' @param data_profiles Tibble. The sensory data.
#' 
#' @importFrom ggplot2 ggplot aes geom_col labs facet_wrap theme_minimal theme element_blank scale_fill_manual
#' @importFrom plotly ggplotly
#' @importFrom dplyr vars distinct
#' @importFrom grDevices colorRampPalette
#' 
#' @return A ggplotly
#' @export
plot_unidim_analysis <- function(data_profiles) {
  
  # Check parameters
  if (isFALSE(is.data.frame(data_profiles))) {
    stop("The data you provided is not a dataframe.")
  }
  
  # Find de number of products
  nb_prod <- data_profiles |> distinct(PRODUCT) |> nrow()
  
  # Static plot
  unidim_plot <- ggplot(data = data_profiles) +
    aes(x = PRODUCT,
        y = SCORE,
        fill = PRODUCT) +
    geom_col() +
    scale_fill_manual(values = colorRampPalette(c("white", "#55B4D2"))(n = nb_prod + 1)[-1]) +
    labs(x = "",
         y = "Intensity on a 0-10 scale") +
    facet_wrap(facets = vars(ATTRIBUTE)) +
    theme_minimal() +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
  
  # Interactive plot
  inter_plot <- ggplotly(
    p = unidim_plot,
    tooltip = c("x", "y")
  )
  
  return(inter_plot)
  
}
```

```{r examples-perform_unidim_analysis, out.width='100%', out.height='100%'}
data("data_profiles_toy")

plot_unidim_analysis(
  data_profiles = data_profiles_toy
)
```

```{r tests-perform_unidim_analysis}
test_that("perform_unidim_analysis works", {

  data("data_profiles_toy")
  
  my_unidim_plot <- plot_unidim_analysis(
    data_profiles = data_profiles_toy
  )
  
  expect_true(inherits(my_unidim_plot, "plotly"))

  # Test an error is the parameter is not a dataframe
  expect_error(
    object = plot_unidim_analysis(data_profiles = 1), 
    regexp = "The data you provided is not a dataframe"
  )
  
})
```

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_perform_unidim_analysis.Rmd", 
  vignette_name = "b - Perform the unidimensional sensory analysis", 
  check = FALSE, 
  overwrite = TRUE,
  open_vignette = FALSE
  )
```

